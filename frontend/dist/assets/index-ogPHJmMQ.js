var e=Object.defineProperty,a=Object.defineProperties,r=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,n=(a,r,t)=>r in a?e(a,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[r]=t,i=(e,a)=>{for(var r in a||(a={}))l.call(a,r)&&n(e,r,a[r]);if(t)for(var r of t(a))o.call(a,r)&&n(e,r,a[r]);return e},s=(e,t)=>a(e,r(t)),u=(e,a,r)=>new Promise(((t,l)=>{var o=e=>{try{i(r.next(e))}catch(a){l(a)}},n=e=>{try{i(r.throw(e))}catch(a){l(a)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(o,n);i((r=r.apply(e,a)).next())}));import{U as d,f as p,_ as c}from"./index-Co7Jc6td.js";/* empty css                   */import{_ as m}from"./ArtTableFullScreen-Bpx86egv.js";/* empty css                */import{u as g,_ as f}from"./useCheckedColumns-BJfyBYT9.js";import{A as v,R as b}from"./formData-DjnVdGbe.js";import{B as h}from"./borrowApi-Dx-XvuOK.js";import{A as y}from"./ArtButtonTable--khuujwm.js";import{_ as w}from"./ArtTable-DOVWYSlp.js";import{k as j,r as D,a2 as P,e as _,S,t as z,y as k,z as x,x as A,i as R,u as I,a$ as N,m as C,I as T,J as U,aN as O,b0 as E,a6 as G,v as H,O as V,a_ as B,aZ as L,T as J,G as W,aH as $,aS as F,P as K,E as M,_ as X}from"./vendor-CJD3O2Jl.js";/* empty css               *//* empty css               *//* empty css                       *//* empty css                 *//* empty css                       *//* empty css                      *//* empty css                        *//* empty css                    *//* empty css                 */import"./formEnum-BLgiZVxV.js";const Z={class:"account-page",id:"table-full-screen"},q={key:0,class:"empty-state"},Q={class:"pagination-container",style:{"margin-top":"20px","text-align":"right"}},Y=c(j(s(i({},{name:"User"}),{__name:"index",setup(e){const a=D(!1),r={name:"",phone:"",email:"",date:"",daterange:""},t=D(!1),l=D(!1),o=D([]),n=P({currentPage:1,pageSize:10,total:0});let c=D(null),j=D("");const Y=e=>{if(!e)return"N/A";try{const a=new Date(e);return isNaN(a.getTime())?"N/A":a.toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"})}catch(a){return"N/A"}},ee=e=>{if(e.actualReturnDate)return"已归还";if(null===e.returnDate||void 0===e.returnDate)return"借阅中";try{const a=new Date(e.returnDate),r=new Date;return r.setHours(0,0,0,0),a.setHours(0,0,0,0),a<r?"已逾期":"借阅中"}catch(a){return"借阅中"}},ae=e=>{switch(ee(e)){case"已归还":return"success";case"已逾期":return"danger";case"借阅中":return"warning";default:return"info"}},re=e=>u(this,null,(function*(){var a;const r=e.userId||e.id||e.user_id;if(r){c.value=r,j.value=e.name||e.username||(null==(a=e.profile)?void 0:a.realName)||"未知用户",t.value=!0,l.value=!0,n.currentPage=1,n.total=0,o.value=[];try{yield te()}catch(i){M.error("获取借阅记录失败"),l.value=!1}}else M.error("无法获取用户ID")})),te=()=>u(this,null,(function*(){if(!c.value)return M.error("用户ID不存在"),void(l.value=!1);l.value=!0;try{const e={userId:c.value.toString(),current:n.currentPage,size:n.pageSize},a=yield h.getBorrowRecords(e);if(a.code===p.success){let e=[];a.data&&(Array.isArray(a.data)?e=a.data:a.data.records&&Array.isArray(a.data.records)?(e=a.data.records,n.total=a.data.total||0):("object"==typeof a.data&&a.data.records||"object"==typeof a.data)&&(e=[a.data]));const r=e.filter((e=>{var a,r;return(e.userId||e.user_id||(null==(a=e.borrower)?void 0:a.userId)||(null==(r=e.user)?void 0:r.userId))==c.value}));o.value=r.map((e=>({id:e.recordId||e.id||e.borrowId,bookTitle:le(e),borrowerName:oe(e),borrowDate:e.borrowDate||e.createdAt,returnDate:e.returnDate||e.dueDate||e.expectedReturnDate,actualReturnDate:e.actualReturnDate||e.returnedAt||null,status:e.status,userId:e.userId||e.user_id,_raw:e}))),void 0!==a.data.total?n.total=a.data.total:n.total=r.length,o.value.length}else M.error(a.message||"获取借阅记录失败"),o.value=[],n.total=0}catch(e){M.error("获取借阅记录失败，请重试"),o.value=[],n.total=0}finally{l.value=!1}})),le=e=>{var a,r,t;return e.bookTitle||(null==(a=e.bookId)?void 0:a.title)||(null==(r=e.book)?void 0:r.title)||(null==(t=e.book)?void 0:t.name)||e.bookName||"未知书籍"},oe=e=>{var a,r,t,l;return e.borrowerName||(null==(r=null==(a=e.user)?void 0:a.profile)?void 0:r.realName)||(null==(t=e.borrower)?void 0:t.name)||(null==(l=e.user)?void 0:l.name)||e.userName||j.value||"未知用户"},ne=e=>{n.pageSize=e,n.currentPage=1,te()},ie=e=>{n.currentPage=e,te()},se=D([]),ue=P(i({},r)),de=P({currentPage:1,pageSize:20,total:0}),pe=D([]),ce=D(),me=D([]),ge=()=>{Object.assign(ue,i({},r)),de.currentPage=1,ye()},fe=()=>{de.currentPage=1,ye()},ve=e=>{},be=[{label:"用户名",prop:"name",type:"input",config:{clearable:!0},onChange:ve},{label:"电话",prop:"phone",type:"input",config:{clearable:!0},onChange:ve},{label:"邮箱",prop:"email",type:"input",config:{clearable:!0},onChange:ve},{prop:"date",label:"日期",type:"date",config:{type:"date",placeholder:"请选择日期"}},{prop:"daterange",label:"日期范围",type:"daterange",config:{type:"daterange",startPlaceholder:"开始时间",endPlaceholder:"结束时间"}}],{columns:he}=g((()=>[{prop:"avatar",label:"用户信息",minWidth:220,formatter:e=>X("div",{class:"user",style:"display: flex; align-items: center"},[X("img",{class:"avatar",src:e.avatar}),X("div",{},[X("p",{class:"user-name"},[X("span",{},e.name),X("span",{class:"user-role"},`（${{R_SUPER:"超级管理员",R_ADMIN:"管理员",R_USER:"普通用户"}[e.role]||e.role}）`)]),X("p",{class:"email"},e.userEmail)])])},{prop:"userGender",label:"性别",sortable:!0,formatter:e=>"1"===e.userGender?"男":"女"},{prop:"userPhone",label:"手机号"},{prop:"username",label:"账号",formatter:e=>e.username},{prop:"createTime",label:"创建日期",sortable:!0},{prop:"operation",label:"操作",width:150,formatter:e=>X("div",[X(y,{type:"eye",text:"查看借阅记录",onClick:()=>re(e)})])}]));_((()=>{ye(),we()}));const ye=()=>u(this,null,(function*(){a.value=!0;try{const e={current:de.currentPage,size:de.pageSize};ue.name&&(e.keyword=ue.name),ue.phone&&(e.phone=ue.phone),ue.email&&(e.email=ue.email),ue.date&&(e.date=ue.date),ue.daterange&&2===ue.daterange.length&&(e.startDate=ue.daterange[0],e.endDate=ue.daterange[1]);const a=yield d.getUserList(e);if(a.code===p.success){const e=a.data.map(((e,a)=>{var r,t,l,o,n,u,d,p,c;const m=a%v.length;return s(i({},e),{avatar:(null==(r=e.profile)?void 0:r.avatar)||v[m].avatar,name:(null==(t=e.profile)?void 0:t.realName)||e.username,userEmail:null==(l=e.profile)?void 0:l.email,userPhone:null==(o=e.profile)?void 0:o.phone,userGender:null==(n=e.profile)?void 0:n.sex,nickname:null==(u=e.profile)?void 0:u.nickname,school:null==(d=e.profile)?void 0:d.school,description:null==(p=e.profile)?void 0:p.description,createTime:e.createdAt,backgroundUrl:null==(c=e.profile)?void 0:c.backgroundUrl})}));pe.value=e,de.total=a.data.length}}catch(e){}finally{a.value=!1}})),we=()=>{se.value=b},je=e=>{me.value=e},De=e=>{de.pageSize=e,ye()},Pe=e=>{de.currentPage=e,ye()};return(e,r)=>{const i=f,s=K,u=N,d=m,p=$;return z(),S(d,null,{default:k((()=>[x("div",Z,[A(i,{filter:I(ue),"onUpdate:filter":r[0]||(r[0]=e=>R(ue)?ue.value=e:null),items:be,onReset:ge,onSearch:fe},null,8,["filter"]),A(u,{shadow:"never",class:"art-table-card"},{default:k((()=>[A(w,{ref_key:"tableRef",ref:ce,"row-key":"id",loading:I(a),data:I(pe),currentPage:I(de).currentPage,pageSize:I(de).pageSize,total:I(de).total,marginTop:10,onSelectionChange:je,onSizeChange:De,onCurrentChange:Pe},{default:k((()=>[(z(!0),C(T,null,U(I(he),(e=>(z(),S(I(O),E({key:e.prop||e.type},{ref_for:!0},e),null,16)))),128))])),_:1},8,["loading","data","currentPage","pageSize","total"]),A(I(G),{modelValue:I(t),"onUpdate:modelValue":r[4]||(r[4]=e=>R(t)?t.value=e:null),width:"80%","align-center":""},{title:k((()=>r[5]||(r[5]=[x("div",{style:{"font-size":"18px","text-align":"center"}},"用户借阅记录",-1)]))),footer:k((()=>[A(s,{onClick:r[3]||(r[3]=e=>t.value=!1)},{default:k((()=>r[7]||(r[7]=[J("关闭")]))),_:1,__:[7]})])),default:k((()=>[I(l)||0!==I(o).length?H("",!0):(z(),C("div",q,r[6]||(r[6]=[x("p",null,"该用户暂无借阅记录",-1)]))),V((z(),S(I(B),{data:I(o),style:{width:"100%"},stripe:"",border:""},{default:k((()=>[A(I(O),{prop:"bookTitle",label:"书籍名称","min-width":"180","show-overflow-tooltip":""}),A(I(O),{prop:"borrowerName",label:"借阅人","min-width":"120"}),A(I(O),{prop:"borrowDate",label:"借阅日期","min-width":"120",formatter:e=>Y(e.borrowDate)},null,8,["formatter"]),A(I(O),{prop:"returnDate",label:"应还日期","min-width":"120",formatter:e=>Y(e.returnDate)},null,8,["formatter"]),A(I(O),{prop:"actualReturnDate",label:"实际归还日期","min-width":"130",formatter:e=>e.actualReturnDate?Y(e.actualReturnDate):"未归还"},null,8,["formatter"]),A(I(O),{label:"借阅状态","min-width":"100",formatter:ee},{default:k((({row:e})=>[A(I(L),{type:ae(e)},{default:k((()=>[J(W(ee(e)),1)])),_:2},1032,["type"])])),_:1})])),_:1},8,["data"])),[[p,I(l)]]),x("div",Q,[A(I(F),{"current-page":I(n).currentPage,"onUpdate:currentPage":r[1]||(r[1]=e=>I(n).currentPage=e),"page-size":I(n).pageSize,"onUpdate:pageSize":r[2]||(r[2]=e=>I(n).pageSize=e),"page-sizes":[10,20,50,100],total:I(n).total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ne,onCurrentChange:ie},null,8,["current-page","page-size","total"])])])),_:1},8,["modelValue"])])),_:1})])])),_:1})}}})),[["__scopeId","data-v-e86dc98e"]]);export{Y as default};
