var e=Object.defineProperty,a=Object.defineProperties,l=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,s=(a,l,r)=>l in a?e(a,l,{enumerable:!0,configurable:!0,writable:!0,value:r}):a[l]=r,n=(e,a,l)=>new Promise(((r,t)=>{var o=e=>{try{n(l.next(e))}catch(a){t(a)}},s=e=>{try{n(l.throw(e))}catch(a){t(a)}},n=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,s);n((l=l.apply(e,a)).next())}));import{b as u,f as i,_ as d}from"./index-D1Hg0Vwf.js";/* empty css                   */import{_ as c}from"./ArtTableFullScreen-BwfyNbV_.js";/* empty css                      *//* empty css                        *//* empty css                    *//* empty css                */import{B as v}from"./borrowApi-nU-wAjg-.js";import{k as b,r as p,a2 as g,c as f,w,e as h,S as k,t as m,y,z as D,x as _,G as I,L as C,a$ as P,ad as S,ae as j,m as x,v as z,O,a_ as T,aN as A,aZ as V,T as N,F as U,P as L,aH as R,aS as B,a6 as E,b1 as H,a3 as F,a4 as G,E as q}from"./vendor-CJD3O2Jl.js";const J={class:"personal-records-page"},M={class:"top-section"},Z={class:"stats-cards"},$={class:"stat-card total"},K={class:"stat-number"},Q={class:"stat-card overdue"},W={class:"stat-number"},X={class:"stat-card borrowing"},Y={class:"stat-number"},ee={class:"search-section"},ae={class:"filter-row"},le={class:"table-container"},re={class:"book-info"},te={class:"book-cover-container"},oe=["src","alt"],se={key:1,class:"no-cover"},ne={class:"book-details"},ue={class:"book-title"},ie={class:"book-meta"},de={class:"author"},ce={class:"publisher"},ve={class:"book-category"},be={class:"borrow-info"},pe={class:"info-row"},ge={class:"value"},fe={key:0,class:"info-row"},we={class:"value"},he={key:1,class:"info-row"},ke={class:"value"},me={key:1,class:"returned-text"},ye={key:0,class:"pagination-container"},De={class:"return-dialog-content"},_e={class:"book-summary"},Ie={class:"dialog-book-cover-container"},Ce=["src","alt"],Pe={key:1,class:"dialog-no-cover"},Se={class:"dialog-book-info"},je={class:"borrow-date"},xe={class:"due-date"},ze={class:"dialog-footer"},Oe=b((Te=((e,a)=>{for(var l in a||(a={}))t.call(a,l)&&s(e,l,a[l]);if(r)for(var l of r(a))o.call(a,l)&&s(e,l,a[l]);return e})({},{name:"PersonalRecords"}),Ae={__name:"index",setup(e){const a=u(),l=p(!1),r=p(!1),t=p([]),o=p([]),s=p(!1),d=p(""),b=p(""),Oe=p(""),Te=p(null),Ae=g({currentPage:1,pageSize:10,total:0}),Ve=f((()=>t.value.filter((e=>"借阅中"===Ee(e))).length)),Ne=f((()=>t.value.filter((e=>"已逾期"===Ee(e))).length)),Ue=()=>n(this,null,(function*(){var e;try{l.value=!0;const r=null==(e=a.info)?void 0:e.userId;if(!r)return void q.error("用户信息不存在，请重新登录");const o=yield v.getBorrowRecordsByUserId(r);if(o.code===i.success){let e=[];o.data&&(e=Array.isArray(o.data)?o.data:[o.data]),t.value=e.map((e=>{var a,l,r,t,o,s,n;return{recordId:e.recordId,borrowId:e.borrowId||e.recordId,bookTitle:(null==(a=e.bookId)?void 0:a.title)||e.title||"未知图书",bookAuthor:(null==(l=e.bookId)?void 0:l.author)||e.author||"未知作者",bookPublisher:(null==(r=e.bookId)?void 0:r.publisher)||e.publisher||"未知出版社",bookCategory:(null==(t=e.bookId)?void 0:t.category)||e.category||"未分类",bookCover:(null==(o=e.bookId)?void 0:o.cover)||e.cover,borrowDate:e.borrowDate,dueDate:e.dueDate,returnDate:e.returnDate,status:e.status,userId:(null==(s=e.user)?void 0:s.userId)||e.userId,bookId:(null==(n=e.bookId)?void 0:n.bookId)||e.bookId,_original:e}})).sort(((e,a)=>{const l=new Date(e.borrowDate||0).getTime();return new Date(a.borrowDate||0).getTime()-l})),Le(),0===t.value.length&&q.info("暂无借阅记录")}else q.error(o.message||"获取借阅记录失败"),t.value=[]}catch(r){q.error("获取借阅记录失败，请重试"),t.value=[]}finally{l.value=!1}})),Le=()=>{let e=[...t.value];if(b.value&&(e=e.filter((e=>Re(e)===b.value))),Oe.value){const a=Oe.value.toLowerCase();e=e.filter((e=>e.bookTitle.toLowerCase().includes(a)||e.bookAuthor.toLowerCase().includes(a)))}Ae.total=e.length;const a=(Ae.currentPage-1)*Ae.pageSize,l=a+Ae.pageSize;o.value=e.slice(a,l)},Re=e=>{if(e.returnDate&&e.returnDate>e.dueDate)return"ReturnOver";if(e.returnDate)return"returned";if(!e.returnDate)return"borrowing";const a=new Date,l=new Date(e.dueDate);return a.setHours(0,0,0,0),l.setHours(0,0,0,0),a>l?"overdue":"borrowing"},Be=e=>{if(!e)return"N/A";try{const a=new Date(e);return isNaN(a.getTime())?"N/A":a.toLocaleDateString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit"})}catch(a){return"N/A"}},Ee=e=>{switch(Re(e)){case"returned":return"已归还";case"overdue":return"已逾期";case"borrowing":default:return"借阅中";case"ReturnOver":return"逾期归还"}},He=e=>{switch(Ee(e)){case"已归还":return"success";case"已逾期":return"danger";case"逾期归还":case"借阅中":return"warning";default:return"info"}},Fe=e=>{switch(Ee(e)){case"已归还":return"el-icon-check";case"已逾期":return"el-icon-warning";case"借阅中":return"el-icon-time";default:return"el-icon-info"}},Ge=()=>n(this,null,(function*(){if(d.value)if(Te.value)try{r.value=!0;const e=Te.value.borrowId||Te.value.recordId;yield v.returnBook(e,{actualReturnDate:d.value}),q.success("归还成功！"),s.value=!1,yield Ue()}catch(e){q.error("归还失败，请重试")}finally{r.value=!1}else q.error("未选择要归还的图书");else q.error("请选择归还日期")})),qe=e=>{const a=e.target;a.style.display="none";const l=a.parentElement;l&&(l.innerHTML='<div class="no-cover">暂无封面</div>')},Je=e=>{Ae.pageSize=e,Ae.currentPage=1,Le()},Me=e=>{Ae.currentPage=e,Le()};return w([b,Oe],(()=>{Ae.currentPage=1,Le()})),h((()=>{Ue()})),(e,a)=>{const n=C,u=j,i=S,v=P,p=A,g=V,f=L,w=T,h=B,q=H,Ue=G,Re=F,Ze=E,$e=c,Ke=R;return m(),k($e,null,{default:y((()=>[D("div",J,[D("div",M,[D("div",Z,[D("div",$,[D("div",K,I(t.value.length),1),a[6]||(a[6]=D("div",{class:"stat-label"},"总借阅数",-1))]),D("div",Q,[D("div",W,I(Ne.value),1),a[7]||(a[7]=D("div",{class:"stat-label"},"已逾期",-1))]),D("div",X,[D("div",Y,I(Ve.value),1),a[8]||(a[8]=D("div",{class:"stat-label"},"借阅中",-1))])]),D("div",ee,[_(n,{modelValue:Oe.value,"onUpdate:modelValue":a[0]||(a[0]=e=>Oe.value=e),placeholder:"搜索图书名称",clearable:"",style:{width:"300px"},"prefix-icon":"Search",onInput:Le},null,8,["modelValue"])])]),_(v,{shadow:"never",class:"filter-card"},{default:y((()=>[D("div",ae,[_(i,{modelValue:b.value,"onUpdate:modelValue":a[1]||(a[1]=e=>b.value=e),placeholder:"选择状态",clearable:"",style:{width:"200px"},onChange:Le},{default:y((()=>[_(u,{label:"全部",value:""}),_(u,{label:"借阅中",value:"borrowing"}),_(u,{label:"已归还",value:"returned"}),_(u,{label:"已逾期",value:"overdue"}),_(u,{label:"逾期归还",value:"ReturnOver"})])),_:1},8,["modelValue"])])])),_:1}),_(v,{shadow:"never",class:"table-card"},{default:y((()=>[D("div",le,[O((m(),k(w,{data:o.value,stripe:"",style:{width:"100%"},"empty-text":l.value?"加载中...":"暂无借阅记录",height:"600"},{default:y((()=>[_(p,{label:"图书信息","min-width":"300"},{default:y((({row:e})=>[D("div",re,[D("div",te,[e.bookCover?(m(),x("img",{key:0,src:e.bookCover,alt:e.bookTitle,class:"book-cover",onError:qe},null,40,oe)):(m(),x("div",se," 暂无封面 "))]),D("div",ne,[D("div",ue,I(e.bookTitle),1),D("div",ie,[D("span",de,I(e.bookAuthor),1),a[9]||(a[9]=D("span",{class:"divider"},"•",-1)),D("span",ce,I(e.bookPublisher),1)]),D("div",ve,I(e.bookCategory),1)])])])),_:1}),_(p,{label:"借阅信息","min-width":"200"},{default:y((({row:e})=>[D("div",be,[D("div",pe,[a[10]||(a[10]=D("span",{class:"label"},"借阅日期:",-1)),D("span",ge,I(Be(e.borrowDate)),1)]),e.dueDate?(m(),x("div",fe,[a[11]||(a[11]=D("span",{class:"label"},"应还日期:",-1)),D("span",we,I(Be(e.dueDate)),1)])):z("",!0),e.returnDate?(m(),x("div",he,[a[12]||(a[12]=D("span",{class:"label"},"归还日期:",-1)),D("span",ke,I(Be(e.returnDate)),1)])):z("",!0)])])),_:1}),_(p,{label:"状态",width:"120",align:"center"},{default:y((({row:e})=>[_(g,{type:He(e),size:"large"},{default:y((()=>[D("i",{class:U(Fe(e))},null,2),N(" "+I(Ee(e)),1)])),_:2},1032,["type"])])),_:1}),_(p,{label:"操作",width:"120",align:"center"},{default:y((({row:e})=>[e.returnDate?(m(),x("span",me,"已归还")):(m(),k(f,{key:0,type:"primary",size:"small",disabled:l.value,onClick:a=>{return l=e,Te.value=l,d.value=(new Date).toISOString().split("T")[0],void(s.value=!0);var l}},{default:y((()=>a[13]||(a[13]=[N(" 归还图书 ")]))),_:2,__:[13]},1032,["disabled","onClick"]))])),_:1})])),_:1},8,["data","empty-text"])),[[Ke,l.value]])]),t.value.length>0?(m(),x("div",ye,[_(h,{"current-page":Ae.currentPage,"onUpdate:currentPage":a[2]||(a[2]=e=>Ae.currentPage=e),"page-size":Ae.pageSize,"onUpdate:pageSize":a[3]||(a[3]=e=>Ae.pageSize=e),"page-sizes":[5,10,20,50],total:Ae.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Je,onCurrentChange:Me},null,8,["current-page","page-size","total"])])):z("",!0)])),_:1}),_(Ze,{modelValue:s.value,"onUpdate:modelValue":a[5]||(a[5]=e=>s.value=e),title:"归还图书",width:"500px","close-on-click-modal":!1,"align-center":""},{footer:y((()=>[D("div",ze,[_(f,{onClick:a[4]||(a[4]=e=>s.value=!1),disabled:r.value},{default:y((()=>a[14]||(a[14]=[N(" 取消 ")]))),_:1,__:[14]},8,["disabled"]),_(f,{type:"primary",onClick:Ge,loading:r.value},{default:y((()=>a[15]||(a[15]=[N(" 确认归还 ")]))),_:1,__:[15]},8,["loading"])])])),default:y((()=>{var e,a,l,r,t,o,s;return[D("div",De,[D("div",_e,[D("div",Ie,[(null==(e=Te.value)?void 0:e.bookCover)?(m(),x("img",{key:0,src:null==(a=Te.value)?void 0:a.bookCover,alt:null==(l=Te.value)?void 0:l.bookTitle,class:"dialog-book-cover"},null,8,Ce)):(m(),x("div",Pe," 暂无封面 "))]),D("div",Se,[D("h4",null,I(null==(r=Te.value)?void 0:r.bookTitle),1),D("p",null,I(null==(t=Te.value)?void 0:t.bookAuthor),1),D("p",je,"借阅日期: "+I(Be(null==(o=Te.value)?void 0:o.borrowDate)),1),D("p",xe,"应还日期: "+I(Be(null==(s=Te.value)?void 0:s.dueDate)),1)])]),_(q),_(Re,{"label-width":"100px"},{default:y((()=>[_(Ue,{label:"归还日期",required:""},{default:y((()=>[_(n,{value:Be(d.value),readonly:"",style:{width:"100%"},placeholder:"系统当前时间"},null,8,["value"])])),_:1})])),_:1})])]})),_:1},8,["modelValue"])])])),_:1})}}},a(Te,l(Ae))));var Te,Ae;const Ve=d(Oe,[["__scopeId","data-v-9f20a173"]]);export{Ve as default};
